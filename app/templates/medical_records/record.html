{% extends 'base.html' %}

{% block title %}Medical Record Details{% endblock %}

{% block styles %}
<style>
    .record-header {
        background-color: #f5f8f7;
        border-left: 4px solid var(--rafad-green);
        border-radius: 4px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .record-badge {
        font-size: 0.8rem;
        padding: 0.3rem 0.6rem;
    }
    
    .diagnosis-badge {
        background-color: var(--medical-blue);
    }
    
    .prescription-badge {
        background-color: var(--rafad-green);
    }
    
    .treatment-badge {
        background-color: var(--medical-mint);
    }
    
    .test-badge {
        background-color: var(--medical-lavender);
    }
    
    .note-badge {
        background-color: var(--rafad-gray);
    }
    
    .detail-section {
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .detail-section:last-child {
        border-bottom: none;
        padding-bottom: 0;
    }
    
    .detail-section-title {
        color: var(--rafad-green);
        font-weight: 600;
        margin-bottom: 1rem;
    }
    
    .record-metadata {
        color: #6c757d;
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mb-0">Medical Record</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    {% if current_user.is_doctor() %}
                    <li class="breadcrumb-item"><a href="{{ url_for('doctor.dashboard') }}">Doctor Dashboard</a></li>
                    {% elif current_user.is_patient() %}
                    <li class="breadcrumb-item"><a href="{{ url_for('patient.dashboard') }}">Patient Dashboard</a></li>
                    {% endif %}
                    <li class="breadcrumb-item"><a href="{{ url_for('medical_records.view', patient_id=record.patient_id) }}">Medical Records</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Record Details</li>
                </ol>
            </nav>
        </div>
        <div>
            <a href="{{ url_for('medical_records.view', patient_id=record.patient_id) }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Back to Records
            </a>
            {% if current_user.is_doctor() and current_user.doctor.id == record.doctor_id %}
            <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteRecordModal">
                <i class="fas fa-trash-alt me-1"></i> Delete Record
            </button>
            {% endif %}
        </div>
    </div>
    
    <!-- Record Header -->
    <div class="record-header">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                {% if record.record_type == 'diagnosis' %}
                <span class="badge record-badge diagnosis-badge">Diagnosis</span>
                {% elif record.record_type == 'prescription' %}
                <span class="badge record-badge prescription-badge">Prescription</span>
                {% elif record.record_type == 'treatment' %}
                <span class="badge record-badge treatment-badge">Treatment</span>
                {% elif record.record_type == 'test' %}
                <span class="badge record-badge test-badge">Test Result</span>
                {% else %}
                <span class="badge record-badge note-badge">Medical Note</span>
                {% endif %}
                
                {% if record.is_confidential %}
                <span class="badge bg-warning ms-1">Confidential</span>
                {% endif %}
            </div>
            <div class="record-metadata">
                Created: {{ record.created_at.strftime('%b %d, %Y %I:%M %p') }}
                {% if record.updated_at and record.updated_at != record.created_at %}
                | Updated: {{ record.updated_at.strftime('%b %d, %Y %I:%M %p') }}
                {% endif %}
            </div>
        </div>
        <h2 class="mb-1">{{ record.title }}</h2>
        <p class="mb-0">
            <i class="fas fa-calendar-alt me-1 text-muted"></i>
            {{ record.record_date.strftime('%B %d, %Y') }}
            <span class="mx-2">|</span>
            <i class="fas fa-user-md me-1 text-muted"></i>
            Dr. {{ record.doctor.user.first_name }} {{ record.doctor.user.last_name }}
            {% if record.appointment_id %}
            <span class="mx-2">|</span>
            <i class="fas fa-calendar-check me-1 text-muted"></i>
            <a href="{{ url_for('appointment.view', appointment_id=record.appointment_id) }}">
                View Related Appointment
            </a>
            {% endif %}
        </p>
    </div>
    
    <div class="row">
        <div class="col-lg-8">
            <!-- Main Record Content -->
            <div class="card mb-4">
                <div class="card-body">
                    <!-- Description Section -->
                    <div class="detail-section">
                        <h5 class="detail-section-title">
                            <i class="fas fa-file-medical me-2"></i> Description
                        </h5>
                        <p>{{ record.description|nl2br }}</p>
                    </div>
                    
                    <!-- Record Type Specific Details -->
                    {% if record.record_type == 'diagnosis' and record.diagnoses.first() %}
                    {% set diagnosis = record.diagnoses.first() %}
                    <div class="detail-section">
                        <h5 class="detail-section-title">
                            <i class="fas fa-stethoscope me-2"></i> Diagnosis Details
                        </h5>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Diagnosis Name:</strong>
                                <p>{{ diagnosis.diagnosis_name }}</p>
                            </div>
                            <div class="col-md-6">
                                <strong>Diagnosis Code:</strong>
                                <p>{{ diagnosis.diagnosis_code or 'N/A' }}</p>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Severity:</strong>
                                <p>
                                    {% if diagnosis.severity == 'mild' %}
                                    <span class="badge bg-success">Mild</span>
                                    {% elif diagnosis.severity == 'moderate' %}
                                    <span class="badge bg-warning">Moderate</span>
                                    {% elif diagnosis.severity == 'severe' %}
                                    <span class="badge bg-danger">Severe</span>
                                    {% endif %}
                                </p>
                            </div>
                            <div class="col-md-6">
                                <strong>Primary Diagnosis:</strong>
                                <p>{{ 'Yes' if diagnosis.is_primary else 'No' }}</p>
                            </div>
                        </div>
                        {% if diagnosis.notes %}
                        <strong>Notes:</strong>
                        <p>{{ diagnosis.notes|nl2br }}</p>
                        {% endif %}
                    </div>
                    
                    {% elif record.record_type == 'prescription' and record.prescriptions.first() %}
                    {% set prescription = record.prescriptions.first() %}
                    <div class="detail-section">
                        <h5 class="detail-section-title">
                            <i class="fas fa-prescription me-2"></i> Prescription Details
                        </h5>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Medication:</strong>
                                <p>{{ prescription.medication_name }}</p>
                            </div>
                            <div class="col-md-6">
                                <strong>Dosage:</strong>
                                <p>{{ prescription.dosage }}</p>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Frequency:</strong>
                                <p>{{ prescription.frequency }}</p>
                            </div>
                            <div class="col-md-6">
                                <strong>Duration:</strong>
                                <p>{{ prescription.duration or 'Not specified' }}</p>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Start Date:</strong>
                                <p>{{ prescription.start_date.strftime('%b %d, %Y') }}</p>
                            </div>
                            <div class="col-md-6">
                                <strong>End Date:</strong>
                                <p>{{ prescription.end_date.strftime('%b %d, %Y') if prescription.end_date else 'Not specified' }}</p>
                            </div>
                        </div>
                        {% if prescription.instructions %}
                        <strong>Instructions:</strong>
                        <p>{{ prescription.instructions|nl2br }}</p>
                        {% endif %}
                        <strong>Refills:</strong>
                        <p>{{ prescription.refill_count }}</p>
                    </div>
                    
                    {% elif record.record_type == 'treatment' and record.treatments.first() %}
                    {% set treatment = record.treatments.first() %}
                    <div class="detail-section">
                        <h5 class="detail-section-title">
                            <i class="fas fa-procedures me-2"></i> Treatment Details
                        </h5>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Treatment Name:</strong>
                                <p>{{ treatment.treatment_name }}</p>
                            </div>
                            <div class="col-md-6">
                                <strong>Type:</strong>
                                <p>{{ treatment.treatment_type|capitalize }}</p>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Start Date:</strong>
                                <p>{{ treatment.start_date.strftime('%b %d, %Y %I:%M %p') }}</p>
                            </div>
                            <div class="col-md-6">
                                <strong>End Date:</strong>
                                <p>{{ treatment.end_date.strftime('%b %d, %Y %I:%M %p') if treatment.end_date else 'Not specified' }}</p>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Outcome:</strong>
                                <p>
                                    {% if treatment.outcome == 'successful' %}
                                    <span class="badge bg-success">Successful</span>
                                    {% elif treatment.outcome == 'ongoing' %}
                                    <span class="badge bg-warning">Ongoing</span>
                                    {% elif treatment.outcome == 'inconclusive' %}
                                    <span class="badge bg-info">Inconclusive</span>
                                    {% elif treatment.outcome == 'failed' %}
                                    <span class="badge bg-danger">Failed</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Pending</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        {% if treatment.notes %}
                        <strong>Notes:</strong>
                        <p>{{ treatment.notes|nl2br }}</p>
                        {% endif %}
                    </div>
                    
                    {% elif record.record_type == 'test' and record.test_results.first() %}
                    {% set test = record.test_results.first() %}
                    <div class="detail-section">
                        <h5 class="detail-section-title">
                            <i class="fas fa-vial me-2"></i> Test Result Details
                        </h5>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Test Name:</strong>
                                <p>{{ test.test_name }}</p>
                            </div>
                            <div class="col-md-6">
                                <strong>Category:</strong>
                                <p>{{ test.test_category|capitalize }}</p>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Test Date:</strong>
                                <p>{{ test.test_date.strftime('%b %d, %Y') }}</p>
                            </div>
                            <div class="col-md-6">
                                <strong>Result:</strong>
                                <p>
                                    {{ test.result_value }} {{ test.result_unit }}
                                    {% if test.is_abnormal %}
                                    <span class="badge bg-danger ms-1">Abnormal</span>
                                    {% else %}
                                    <span class="badge bg-success ms-1">Normal</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        {% if test.reference_range %}
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Reference Range:</strong>
                                <p>{{ test.reference_range }}</p>
                            </div>
                        </div>
                        {% endif %}
                        {% if test.notes %}
                        <strong>Notes:</strong>
                        <p>{{ test.notes|nl2br }}</p>
                        {% endif %}
                        {% if test.file_path %}
                        <div class="mt-3">
                            <a href="{{ url_for('medical_records.get_test_file', filename=test.file_path) }}" 
                               class="btn btn-outline-primary" target="_blank">
                                <i class="fas fa-file-medical me-1"></i> View Test Document
                            </a>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Patient Info Card -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Patient Information</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="avatar-circle mx-auto mb-3">
                            <span class="avatar-initials">
                                {{ record.patient.user.first_name[0] }}{{ record.patient.user.last_name[0] }}
                            </span>
                        </div>
                        <h5 class="mb-0">{{ record.patient.user.first_name }} {{ record.patient.user.last_name }}</h5>
                        <p class="text-muted mb-0">
                            {{ record.patient.age }} years | {{ record.patient.gender }}
                        </p>
                    </div>
                    <hr>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="fas fa-phone-alt text-muted me-2"></i>
                            {{ record.patient.user.phone }}
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-envelope text-muted me-2"></i>
                            {{ record.patient.user.email }}
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-calendar-alt text-muted me-2"></i>
                            DOB: {{ record.patient.date_of_birth.strftime('%b %d, %Y') }}
                        </li>
                    </ul>
                    <hr>
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('medical_records.view', patient_id=record.patient_id) }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-history me-1"></i> View All Records
                        </a>
                        {% if current_user.is_doctor() %}
                        <a href="{{ url_for('medical_records.add', patient_id=record.patient_id) }}" class="btn btn-sm btn-outline-success">
                            <i class="fas fa-plus me-1"></i> Add New Record
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Related Records Card -->
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Related Records</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Other records from the same date or related to this condition:</p>
                    <ul class="list-group list-group-flush">
                        {% set related_records = record.patient.medical_records|selectattr('id', 'ne', record.id)|list %}
                        {% if related_records %}
                            {% for related in related_records[:5] %}
                            <li class="list-group-item px-0">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        {% if related.record_type == 'diagnosis' %}
                                        <span class="badge record-badge diagnosis-badge me-1">Diagnosis</span>
                                        {% elif related.record_type == 'prescription' %}
                                        <span class="badge record-badge prescription-badge me-1">Prescription</span>
                                        {% elif related.record_type == 'treatment' %}
                                        <span class="badge record-badge treatment-badge me-1">Treatment</span>
                                        {% elif related.record_type == 'test' %}
                                        <span class="badge record-badge test-badge me-1">Test</span>
                                        {% else %}
                                        <span class="badge record-badge note-badge me-1">Note</span>
                                        {% endif %}
                                        <a href="{{ url_for('medical_records.view_record', record_id=related.id) }}">
                                            {{ related.title }}
                                        </a>
                                    </div>
                                    <small class="text-muted">{{ related.record_date.strftime('%b %d') }}</small>
                                </div>
                            </li>
                            {% endfor %}
                            {% if related_records|length > 5 %}
                            <li class="list-group-item px-0 text-center">
                                <a href="{{ url_for('medical_records.view', patient_id=record.patient_id) }}">
                                    See all {{ related_records|length }} records
                                </a>
                            </li>
                            {% endif %}
                        {% else %}
                            <li class="list-group-item px-0 text-muted">No related records found</li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Record Confirmation Modal -->
{% if current_user.is_doctor() and current_user.doctor.id == record.doctor_id %}
<div class="modal fade" id="deleteRecordModal" tabindex="-1" aria-labelledby="deleteRecordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteRecordModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this medical record?</p>
                <p><strong>Title:</strong> {{ record.title }}</p>
                <p><strong>Date:</strong> {{ record.record_date.strftime('%B %d, %Y') }}</p>
                <p class="text-danger"><strong>Warning:</strong> This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="{{ url_for('medical_records.delete_record', record_id=record.id) }}" method="POST">
                    <button type="submit" class="btn btn-danger">Delete Record</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
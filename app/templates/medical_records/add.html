{% extends 'base.html' %}

{% block title %}Add Medical Record{% endblock %}

{% block styles %}
<style>
    .form-card {
        border: none;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        background-color: white;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .form-section {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .form-section:last-child {
        border-bottom: none;
        padding-bottom: 0;
    }
    
    .form-section-title {
        margin-bottom: 1.25rem;
        color: var(--rafad-green);
        font-weight: 600;
        display: flex;
        align-items: center;
    }
    
    .form-section-title i {
        margin-right: 0.5rem;
        color: var(--rafad-light-green);
    }
    
    .patient-summary {
        background-color: #f5f8f7;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .record-type-nav .nav-link {
        border-radius: 0;
        padding: 1rem;
    }
    
    .record-type-nav .nav-link.active {
        background-color: var(--rafad-green);
        color: white;
    }
    
    .record-type-nav .nav-link:not(.active) {
        background-color: #f5f8f7;
        color: var(--rafad-dark);
    }
    
    .record-type-nav .nav-link i {
        margin-right: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mb-0">Add Medical Record</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('doctor.dashboard') }}">Doctor Dashboard</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Add Medical Record</li>
                </ol>
            </nav>
        </div>
    </div>
    
    <!-- Patient Summary -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="patient-summary">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h5 class="mb-1">Patient: {{ patient.full_name }}</h5>
                        <p class="text-muted mb-0">ID: {{ patient.id }} | Age: {{ patient.age }} | {{ patient.gender }}</p>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <a href="{{ url_for('medical_records.view', patient_id=patient.id) }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-history me-1"></i> View Medical History
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Record Type Navigation -->
    <div class="row mb-4">
        <div class="col-md-12">
            <ul class="nav nav-pills record-type-nav" id="recordTypeTab" role="tablist">
                <li class="nav-item flex-fill" role="presentation">
                    <button class="nav-link active w-100" id="diagnosis-tab" data-bs-toggle="tab" data-bs-target="#diagnosis" type="button" role="tab">
                        <i class="fas fa-stethoscope"></i> Diagnosis
                    </button>
                </li>
                <li class="nav-item flex-fill" role="presentation">
                    <button class="nav-link w-100" id="prescription-tab" data-bs-toggle="tab" data-bs-target="#prescription" type="button" role="tab">
                        <i class="fas fa-prescription"></i> Prescription
                    </button>
                </li>
                <li class="nav-item flex-fill" role="presentation">
                    <button class="nav-link w-100" id="treatment-tab" data-bs-toggle="tab" data-bs-target="#treatment" type="button" role="tab">
                        <i class="fas fa-procedures"></i> Treatment
                    </button>
                </li>
                <li class="nav-item flex-fill" role="presentation">
                    <button class="nav-link w-100" id="test-tab" data-bs-toggle="tab" data-bs-target="#test" type="button" role="tab">
                        <i class="fas fa-vial"></i> Test Result
                    </button>
                </li>
                <li class="nav-item flex-fill" role="presentation">
                    <button class="nav-link w-100" id="note-tab" data-bs-toggle="tab" data-bs-target="#note" type="button" role="tab">
                        <i class="fas fa-sticky-note"></i> Medical Note
                    </button>
                </li>
            </ul>
        </div>
    </div>
    
    <!-- Record Type Forms -->
    <div class="tab-content" id="recordTypeTabContent">
        <!-- Diagnosis Form -->
        <div class="tab-pane fade show active" id="diagnosis" role="tabpanel" aria-labelledby="diagnosis-tab">
            <div class="form-card">
                <form method="POST" action="{{ url_for('medical_records.add_diagnosis', patient_id=patient.id) }}">
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="fas fa-stethoscope"></i>
                            <span>Diagnosis Information</span>
                        </div>
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="diagnosisTitle" class="form-label">Diagnosis Title</label>
                                    <input type="text" class="form-control" id="diagnosisTitle" name="title" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="diagnosisDate" class="form-label">Diagnosis Date</label>
                                    <input type="date" class="form-control" id="diagnosisDate" name="record_date" value="{{ now.strftime('%Y-%m-%d') }}" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="diagnosisDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="diagnosisDescription" name="description" rows="3" required></textarea>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="fas fa-info-circle"></i>
                            <span>Additional Details</span>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="diagnosisCode" class="form-label">Diagnosis Code (ICD-10)</label>
                                    <input type="text" class="form-control" id="diagnosisCode" name="diagnosis_code">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="diagnosisSeverity" class="form-label">Severity</label>
                                    <select class="form-select" id="diagnosisSeverity" name="severity">
                                        <option value="mild">Mild</option>
                                        <option value="moderate">Moderate</option>
                                        <option value="severe">Severe</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="diagnosisNotes" class="form-label">Additional Notes</label>
                            <textarea class="form-control" id="diagnosisNotes" name="notes" rows="2"></textarea>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="isPrimaryDiagnosis" name="is_primary" checked>
                            <label class="form-check-label" for="isPrimaryDiagnosis">
                                This is the primary diagnosis
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="fas fa-shield-alt"></i>
                            <span>Privacy Settings</span>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="isConfidential" name="is_confidential">
                            <label class="form-check-label" for="isConfidential">
                                Mark as confidential
                            </label>
                            <div class="form-text">Confidential records are only visible to you and authorized medical staff.</div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-outline-secondary" onclick="history.back()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Diagnosis</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Prescription Form -->
        <div class="tab-pane fade" id="prescription" role="tabpanel" aria-labelledby="prescription-tab">
            <div class="form-card">
                <form method="POST" action="{{ url_for('medical_records.add_prescription', patient_id=patient.id) }}">
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="fas fa-prescription"></i>
                            <span>Prescription Information</span>
                        </div>
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="medicationName" class="form-label">Medication Name</label>
                                    <input type="text" class="form-control" id="medicationName" name="medication_name" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="prescriptionDate" class="form-label">Prescription Date</label>
                                    <input type="date" class="form-control" id="prescriptionDate" name="record_date" value="{{ now.strftime('%Y-%m-%d') }}" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="prescriptionTitle" class="form-label">Prescription Title</label>
                            <input type="text" class="form-control" id="prescriptionTitle" name="title" required>
                            <div class="form-text">A brief title for this prescription (e.g., "Pain Management", "Antibiotics for Infection")</div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="fas fa-pills"></i>
                            <span>Dosage Information</span>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="dosage" class="form-label">Dosage</label>
                                    <input type="text" class="form-control" id="dosage" name="dosage" required>
                                    <div class="form-text">Amount per dose (e.g., "10mg", "1 tablet")</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="frequency" class="form-label">Frequency</label>
                                    <input type="text" class="form-control" id="frequency" name="frequency" required>
                                    <div class="form-text">How often to take (e.g., "3 times daily", "every 8 hours")</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="duration" class="form-label">Duration</label>
                                    <input type="text" class="form-control" id="duration" name="duration">
                                    <div class="form-text">How long to take (e.g., "7 days", "2 weeks")</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="refillCount" class="form-label">Refill Count</label>
                                    <input type="number" class="form-control" id="refillCount" name="refill_count" value="0" min="0">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="startDate" class="form-label">Start Date</label>
                                    <input type="date" class="form-control" id="startDate" name="start_date" value="{{ now.strftime('%Y-%m-%d') }}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="endDate" class="form-label">End Date</label>
                                    <input type="date" class="form-control" id="endDate" name="end_date">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="instructions" class="form-label">Special Instructions</label>
                            <textarea class="form-control" id="instructions" name="instructions" rows="2"></textarea>
                            <div class="form-text">Additional instructions for the patient (e.g., "Take with food", "Avoid sunlight")</div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="fas fa-file-medical"></i>
                            <span>Additional Information</span>
                        </div>
                        <div class="mb-3">
                            <label for="prescriptionDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="prescriptionDescription" name="description" rows="3"></textarea>
                            <div class="form-text">Additional details about this prescription (e.g., purpose, expected outcomes)</div>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="isPrescriptionConfidential" name="is_confidential">
                            <label class="form-check-label" for="isPrescriptionConfidential">
                                Mark as confidential
                            </label>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-outline-secondary" onclick="history.back()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Prescription</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Treatment Form -->
        <div class="tab-pane fade" id="treatment" role="tabpanel" aria-labelledby="treatment-tab">
            <div class="form-card">
                <form method="POST" action="{{ url_for('medical_records.add_treatment', patient_id=patient.id) }}">
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="fas fa-procedures"></i>
                            <span>Treatment Information</span>
                        </div>
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="treatmentTitle" class="form-label">Treatment Title</label>
                                    <input type="text" class="form-control" id="treatmentTitle" name="title" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="treatmentDate" class="form-label">Treatment Date</label>
                                    <input type="date" class="form-control" id="treatmentDate" name="record_date" value="{{ now.strftime('%Y-%m-%d') }}" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="treatmentName" class="form-label">Treatment Name</label>
                            <input type="text" class="form-control" id="treatmentName" name="treatment_name" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="treatmentType" class="form-label">Treatment Type</label>
                                    <select class="form-select" id="treatmentType" name="treatment_type">
                                        <option value="surgical">Surgical</option>
                                        <option value="therapy">Therapy</option>
                                        <option value="procedure">Procedure</option>
                                        <option value="medication">Medication</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="outcome" class="form-label">Outcome</label>
                                    <select class="form-select" id="outcome" name="outcome">
                                        <option value="pending">Pending</option>
                                        <option value="successful">Successful</option>
                                        <option value="ongoing">Ongoing</option>
                                        <option value="inconclusive">Inconclusive</option>
                                        <option value="failed">Failed</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="fas fa-calendar-alt"></i>
                            <span>Schedule</span>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="treatmentStartDate" class="form-label">Start Date</label>
                                    <input type="datetime-local" class="form-control" id="treatmentStartDate" name="start_date" value="{{ now.strftime('%Y-%m-%dT%H:%M') }}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="treatmentEndDate" class="form-label">End Date</label>
                                    <input type="datetime-local" class="form-control" id="treatmentEndDate" name="end_date">
                                    <div class="form-text">Leave blank if treatment is one-time or ongoing</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="fas fa-info-circle"></i>
                            <span>Details</span>
                        </div>
                        <div class="mb-3">
                            <label for="treatmentDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="treatmentDescription" name="description" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="treatmentNotes" class="form-label">Additional Notes</label>
                            <textarea class="form-control" id="treatmentNotes" name="notes" rows="2"></textarea>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="isTreatmentConfidential" name="is_confidential">
                            <label class="form-check-label" for="isTreatmentConfidential">
                                Mark as confidential
                            </label>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-outline-secondary" onclick="history.back()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Treatment</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Test Result Form -->
        <div class="tab-pane fade" id="test" role="tabpanel" aria-labelledby="test-tab">
            <div class="form-card">
                <form method="POST" action="{{ url_for('medical_records.add_test_result', patient_id=patient.id) }}" enctype="multipart/form-data">
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="fas fa-vial"></i>
                            <span>Test Information</span>
                        </div>
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="testTitle" class="form-label">Test Result Title</label>
                                    <input type="text" class="form-control" id="testTitle" name="title" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="testDate" class="form-label">Test Date</label>
                                    <input type="date" class="form-control" id="testDate" name="record_date" value="{{ now.strftime('%Y-%m-%d') }}" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="testName" class="form-label">Test Name</label>
                                    <input type="text" class="form-control" id="testName" name="test_name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="testCategory" class="form-label">Category</label>
                                    <select class="form-select" id="testCategory" name="test_category">
                                        <option value="blood">Blood Test</option>
                                        <option value="imaging">Imaging</option>
                                        <option value="pathology">Pathology</option>
                                        <option value="urine">Urine Test</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="fas fa-chart-line"></i>
                            <span>Results</span>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="resultValue" class="form-label">Result Value</label>
                                    <input type="text" class="form-control" id="resultValue" name="result_value">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="resultUnit" class="form-label">Unit</label>
                                    <input type="text" class="form-control" id="resultUnit" name="result_unit">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="referenceRange" class="form-label">Reference Range</label>
                            <input type="text" class="form-control" id="referenceRange" name="reference_range">
                            <div class="form-text">Normal range for this test (e.g., "4.0-11.0")</div>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="isAbnormal" name="is_abnormal">
                            <label class="form-check-label" for="isAbnormal">
                                Result is abnormal
                            </label>
                        </div>
                        <div class="mb-3">
                            <label for="testFile" class="form-label">Upload Test Result File</label>
                            <input type="file" class="form-control" id="testFile" name="test_file">
                            <div class="form-text">Upload PDF, image, or document with detailed test results (max 5MB)</div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="fas fa-sticky-note"></i>
                            <span>Additional Information</span>
                        </div>
                        <div class="mb-3">
                            <label for="testDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="testDescription" name="description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="testNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="testNotes" name="notes" rows="2"></textarea>
                            <div class="form-text">Additional notes about the test results, interpretation, or recommendations</div>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="isTestConfidential" name="is_confidential">
                            <label class="form-check-label" for="isTestConfidential">
                                Mark as confidential
                            </label>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-outline-secondary" onclick="history.back()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Test Result</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Medical Note Form -->
        <div class="tab-pane fade" id="note" role="tabpanel" aria-labelledby="note-tab">
            <div class="form-card">
                <form method="POST" action="{{ url_for('medical_records.add_note', patient_id=patient.id) }}">
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="fas fa-sticky-note"></i>
                            <span>Medical Note</span>
                        </div>
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="noteTitle" class="form-label">Note Title</label>
                                    <input type="text" class="form-control" id="noteTitle" name="title" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="noteDate" class="form-label">Date</label>
                                    <input type="date" class="form-control" id="noteDate" name="record_date" value="{{ now.strftime('%Y-%m-%d') }}" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="noteDescription" class="form-label">Note Content</label>
                            <textarea class="form-control" id="noteDescription" name="description" rows="5" required></textarea>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="isNoteConfidential" name="is_confidential">
                            <label class="form-check-label" for="isNoteConfidential">
                                Mark as confidential
                            </label>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-outline-secondary" onclick="history.back()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Note</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
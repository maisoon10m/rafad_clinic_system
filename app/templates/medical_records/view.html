{% extends 'base.html' %}

{% block title %}Patient Medical Records{% endblock %}

{% block styles %}
<style>
    .record-container {
        border-left: 4px solid var(--rafad-green);
        margin-bottom: 1.5rem;
        transition: transform 0.2s ease;
    }
    
    .record-container:hover {
        transform: translateX(5px);
    }
    
    .record-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    
    .record-badge {
        font-size: 0.8rem;
        padding: 0.3rem 0.6rem;
    }
    
    .diagnosis-badge {
        background-color: var(--medical-blue);
    }
    
    .prescription-badge {
        background-color: var(--rafad-green);
    }
    
    .treatment-badge {
        background-color: var(--medical-mint);
    }
    
    .test-badge {
        background-color: var(--medical-lavender);
    }
    
    .note-badge {
        background-color: var(--rafad-gray);
    }
    
    .timeline-container {
        position: relative;
        padding-left: 40px;
    }
    
    .timeline-container::before {
        content: '';
        position: absolute;
        left: 15px;
        top: 0;
        height: 100%;
        width: 2px;
        background-color: var(--rafad-light-green);
    }
    
    .timeline-item {
        position: relative;
        padding-bottom: 1.5rem;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -40px;
        top: 4px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background-color: white;
        border: 2px solid var(--rafad-green);
    }
    
    .record-filters {
        background-color: #f5f8f7;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mb-0">Medical Records</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('patient.dashboard') }}">Patient Dashboard</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Medical Records</li>
                </ol>
            </nav>
        </div>
        <div>
            <a href="#" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#exportRecordsModal">
                <i class="fas fa-file-export me-1"></i> Export Records
            </a>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-3">
            <!-- Patient Info Card -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="avatar-circle mx-auto mb-3">
                            <span class="avatar-initials">{{ patient.first_name[0] }}{{ patient.last_name[0] }}</span>
                        </div>
                        <h5 class="mb-0">{{ patient.full_name }}</h5>
                        <p class="text-muted mb-2">Patient ID: {{ patient.id }}</p>
                        <p class="text-muted mb-0">Age: {{ patient.age }} | {{ patient.gender }}</p>
                    </div>
                    <hr>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="fas fa-phone-alt text-muted me-2"></i>
                            {{ patient.phone }}
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-calendar-alt text-muted me-2"></i>
                            DOB: {{ patient.date_of_birth.strftime('%b %d, %Y') }}
                        </li>
                        {% if patient.address %}
                        <li class="mb-2">
                            <i class="fas fa-map-marker-alt text-muted me-2"></i>
                            {{ patient.address }}
                        </li>
                        {% endif %}
                    </ul>
                    <hr>
                    <div class="d-grid">
                        <a href="{{ url_for('appointment.create', patient_id=patient.id) }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-calendar-plus me-1"></i> Book Appointment
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Medical Record Filters -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Filter Records</h5>
                </div>
                <div class="card-body">
                    <form>
                        <div class="mb-3">
                            <label class="form-label">Record Type</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="" id="diagnosisCheck" checked>
                                <label class="form-check-label" for="diagnosisCheck">Diagnosis</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="" id="prescriptionCheck" checked>
                                <label class="form-check-label" for="prescriptionCheck">Prescription</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="" id="treatmentCheck" checked>
                                <label class="form-check-label" for="treatmentCheck">Treatment</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="" id="testCheck" checked>
                                <label class="form-check-label" for="testCheck">Test Result</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="" id="noteCheck" checked>
                                <label class="form-check-label" for="noteCheck">Medical Note</label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="dateRange" class="form-label">Date Range</label>
                            <select class="form-select" id="dateRange">
                                <option value="all" selected>All Time</option>
                                <option value="30">Last 30 Days</option>
                                <option value="90">Last 90 Days</option>
                                <option value="180">Last 6 Months</option>
                                <option value="365">Last Year</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="doctorFilter" class="form-label">Doctor</label>
                            <select class="form-select" id="doctorFilter">
                                <option value="all" selected>All Doctors</option>
                                <!-- Loop through doctors here -->
                                <option value="1">Dr. Smith</option>
                                <option value="2">Dr. Johnson</option>
                                <option value="3">Dr. Williams</option>
                            </select>
                        </div>
                        
                        <div class="d-grid">
                            <button type="button" class="btn btn-primary">
                                <i class="fas fa-filter me-1"></i> Apply Filters
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-9">
            <!-- Search Bar -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search medical records...">
                        <button class="btn btn-primary" type="button">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Medical Records Timeline -->
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Medical History</h5>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-secondary active">Timeline</button>
                        <button type="button" class="btn btn-outline-secondary">List</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="timeline-container">
                        <!-- Timeline Items - Each represents a medical record -->
                        
                        <!-- Diagnosis Record Example -->
                        <div class="timeline-item">
                            <div class="card record-container">
                                <div class="card-body">
                                    <div class="record-header mb-2">
                                        <div>
                                            <span class="badge record-badge diagnosis-badge">Diagnosis</span>
                                            <span class="ms-2 text-muted">Oct 2, 2025</span>
                                        </div>
                                        <div>
                                            <span class="text-muted">Dr. Smith</span>
                                        </div>
                                    </div>
                                    <h5 class="card-title">Upper Respiratory Infection</h5>
                                    <p class="card-text">Patient presented with symptoms of common cold including runny nose, sore throat, and mild fever.</p>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div>
                                            <span class="badge bg-secondary">ICD-10: J06.9</span>
                                            <span class="badge bg-info ms-1">Mild</span>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#diagnosis1Details">
                                            <i class="fas fa-chevron-down"></i> Details
                                        </button>
                                    </div>
                                    <div class="collapse mt-3" id="diagnosis1Details">
                                        <div class="card card-body bg-light">
                                            <p><strong>Notes:</strong> Patient advised to rest, stay hydrated, and take over-the-counter cold medication.</p>
                                            <p><strong>Related Records:</strong></p>
                                            <ul>
                                                <li><a href="#">Prescription: Cold & Flu Medication</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Prescription Record Example -->
                        <div class="timeline-item">
                            <div class="card record-container">
                                <div class="card-body">
                                    <div class="record-header mb-2">
                                        <div>
                                            <span class="badge record-badge prescription-badge">Prescription</span>
                                            <span class="ms-2 text-muted">Oct 2, 2025</span>
                                        </div>
                                        <div>
                                            <span class="text-muted">Dr. Smith</span>
                                        </div>
                                    </div>
                                    <h5 class="card-title">Cold & Flu Medication</h5>
                                    <p class="card-text">Prescribed for symptom relief of upper respiratory infection.</p>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div>
                                            <span class="badge bg-secondary">7 days</span>
                                            <span class="badge bg-info ms-1">3 times daily</span>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#prescription1Details">
                                            <i class="fas fa-chevron-down"></i> Details
                                        </button>
                                    </div>
                                    <div class="collapse mt-3" id="prescription1Details">
                                        <div class="card card-body bg-light">
                                            <p><strong>Dosage:</strong> 10mg</p>
                                            <p><strong>Instructions:</strong> Take with food. Avoid driving or operating heavy machinery.</p>
                                            <p><strong>Refills:</strong> 0</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Test Result Record Example -->
                        <div class="timeline-item">
                            <div class="card record-container">
                                <div class="card-body">
                                    <div class="record-header mb-2">
                                        <div>
                                            <span class="badge record-badge test-badge">Test Result</span>
                                            <span class="ms-2 text-muted">Sep 28, 2025</span>
                                        </div>
                                        <div>
                                            <span class="text-muted">Dr. Johnson</span>
                                        </div>
                                    </div>
                                    <h5 class="card-title">Complete Blood Count (CBC)</h5>
                                    <p class="card-text">Routine blood test to evaluate overall health and detect a wide range of disorders.</p>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div>
                                            <span class="badge bg-success">Normal Results</span>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#test1Details">
                                            <i class="fas fa-chevron-down"></i> Details
                                        </button>
                                    </div>
                                    <div class="collapse mt-3" id="test1Details">
                                        <div class="card card-body bg-light">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Test</th>
                                                        <th>Result</th>
                                                        <th>Reference Range</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td>WBC</td>
                                                        <td>7.5 x10^9/L</td>
                                                        <td>4.0-11.0 x10^9/L</td>
                                                    </tr>
                                                    <tr>
                                                        <td>RBC</td>
                                                        <td>4.8 x10^12/L</td>
                                                        <td>4.5-5.5 x10^12/L</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Hemoglobin</td>
                                                        <td>14.2 g/dL</td>
                                                        <td>13.5-17.5 g/dL</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Hematocrit</td>
                                                        <td>42%</td>
                                                        <td>38.8-50.0%</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Platelets</td>
                                                        <td>250 x10^9/L</td>
                                                        <td>150-450 x10^9/L</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                            <div class="mt-2">
                                                <a href="#" class="btn btn-sm btn-outline-secondary">
                                                    <i class="fas fa-download me-1"></i> Download PDF
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Treatment Record Example -->
                        <div class="timeline-item">
                            <div class="card record-container">
                                <div class="card-body">
                                    <div class="record-header mb-2">
                                        <div>
                                            <span class="badge record-badge treatment-badge">Treatment</span>
                                            <span class="ms-2 text-muted">Sep 15, 2025</span>
                                        </div>
                                        <div>
                                            <span class="text-muted">Dr. Williams</span>
                                        </div>
                                    </div>
                                    <h5 class="card-title">Physical Therapy - Lower Back</h5>
                                    <p class="card-text">Course of physical therapy for chronic lower back pain.</p>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div>
                                            <span class="badge bg-warning">Ongoing</span>
                                            <span class="badge bg-info ms-1">8 sessions</span>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#treatment1Details">
                                            <i class="fas fa-chevron-down"></i> Details
                                        </button>
                                    </div>
                                    <div class="collapse mt-3" id="treatment1Details">
                                        <div class="card card-body bg-light">
                                            <p><strong>Treatment Plan:</strong> Twice weekly physical therapy sessions for 4 weeks.</p>
                                            <p><strong>Current Progress:</strong> Patient reports reduced pain levels after 3 sessions.</p>
                                            <p><strong>Notes:</strong> Recommended continued home exercises between sessions.</p>
                                            <p><strong>Next Session:</strong> Oct 5, 2025</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Medical Note Example -->
                        <div class="timeline-item">
                            <div class="card record-container">
                                <div class="card-body">
                                    <div class="record-header mb-2">
                                        <div>
                                            <span class="badge record-badge note-badge">Note</span>
                                            <span class="ms-2 text-muted">Sep 10, 2025</span>
                                        </div>
                                        <div>
                                            <span class="text-muted">Dr. Johnson</span>
                                        </div>
                                    </div>
                                    <h5 class="card-title">Follow-up Visit</h5>
                                    <p class="card-text">Patient came for routine follow-up. Reports feeling better with current medication regimen.</p>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div>
                                            <span class="badge bg-secondary">General Note</span>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#note1Details">
                                            <i class="fas fa-chevron-down"></i> Details
                                        </button>
                                    </div>
                                    <div class="collapse mt-3" id="note1Details">
                                        <div class="card card-body bg-light">
                                            <p>Patient continues to make progress. All vital signs are within normal range. Advised to maintain current lifestyle changes including diet and exercise.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export Records Modal -->
<div class="modal fade" id="exportRecordsModal" tabindex="-1" aria-labelledby="exportRecordsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exportRecordsModalLabel">Export Medical Records</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label class="form-label">Select Format</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="exportFormat" id="formatPDF" checked>
                            <label class="form-check-label" for="formatPDF">
                                <i class="fas fa-file-pdf text-danger me-2"></i> PDF Document
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="exportFormat" id="formatCSV">
                            <label class="form-check-label" for="formatCSV">
                                <i class="fas fa-file-csv text-success me-2"></i> CSV Spreadsheet
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Date Range</label>
                        <div class="input-group mb-3">
                            <span class="input-group-text">From</span>
                            <input type="date" class="form-control">
                        </div>
                        <div class="input-group">
                            <span class="input-group-text">To</span>
                            <input type="date" class="form-control" value="{{ now.strftime('%Y-%m-%d') }}">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Include Record Types</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="" id="includeDiagnosis" checked>
                            <label class="form-check-label" for="includeDiagnosis">Diagnoses</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="" id="includePrescriptions" checked>
                            <label class="form-check-label" for="includePrescriptions">Prescriptions</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="" id="includeTreatments" checked>
                            <label class="form-check-label" for="includeTreatments">Treatments</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="" id="includeTests" checked>
                            <label class="form-check-label" for="includeTests">Test Results</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="" id="includeNotes" checked>
                            <label class="form-check-label" for="includeNotes">Medical Notes</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary">Export Records</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Record Type Filter Functionality
        const checkboxes = document.querySelectorAll('.form-check-input[type="checkbox"]');
        const recordTypes = {
            'diagnosisCheck': 'diagnosis',
            'prescriptionCheck': 'prescription',
            'treatmentCheck': 'treatment',
            'testCheck': 'test',
            'noteCheck': 'note'
        };
        
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const recordType = recordTypes[this.id];
                if (recordType) {
                    const recordElements = document.querySelectorAll(`.${recordType}-badge`);
                    recordElements.forEach(el => {
                        const timelineItem = el.closest('.timeline-item');
                        if (timelineItem) {
                            if (this.checked) {
                                timelineItem.style.display = '';
                            } else {
                                timelineItem.style.display = 'none';
                            }
                        }
                    });
                }
            });
        });
    });
</script>
{% endblock %}
{% extends 'base.html' %}

{% block title %}Reporting Dashboard{% endblock %}

{% block styles %}
<link href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css" rel="stylesheet">
<style>
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 2rem;
    }
    .report-card {
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .report-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    }
    .report-icon {
        font-size: 2rem;
        color: var(--rafad-green);
        margin-bottom: 1rem;
    }
    .report-tabs .nav-link {
        color: var(--rafad-dark);
        border-radius: 0;
        padding: 1rem 1.5rem;
    }
    .report-tabs .nav-link.active {
        color: var(--rafad-green);
        border-bottom: 3px solid var(--rafad-green);
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">Reporting & Analytics</h1>
        <button type="button" class="btn btn-primary" id="exportCSV">
            <i class="fas fa-file-csv me-1"></i> Export CSV
        </button>
    </div>

    <!-- Summary Metrics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card report-card bg-white">
                <div class="card-body text-center">
                    <div class="report-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <h5 class="card-title">Total Appointments</h5>
                    <h2 class="mb-0" id="totalAppointments">Loading...</h2>
                    <p class="text-muted small">60-day window</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card report-card bg-white">
                <div class="card-body text-center">
                    <div class="report-icon">
                        <i class="fas fa-user-md"></i>
                    </div>
                    <h5 class="card-title">Doctor Utilization</h5>
                    <h2 class="mb-0" id="avgUtilization">Loading...</h2>
                    <p class="text-muted small">Average appointments per doctor</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card report-card bg-white">
                <div class="card-body text-center">
                    <div class="report-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <h5 class="card-title">New Patients</h5>
                    <h2 class="mb-0" id="newPatients">Loading...</h2>
                    <p class="text-muted small">New registrations</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card report-card bg-white">
                <div class="card-body text-center">
                    <div class="report-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h5 class="card-title">Growth Rate</h5>
                    <h2 class="mb-0" id="growthRate">Loading...</h2>
                    <p class="text-muted small">vs. previous period</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row">
        <!-- Daily Appointments Chart -->
        <div class="col-md-8">
            <div class="card report-card bg-white mb-4">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Daily Appointments</h5>
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-secondary active" data-period="week">Week</button>
                            <button type="button" class="btn btn-outline-secondary" data-period="month">Month</button>
                            <button type="button" class="btn btn-outline-secondary" data-period="quarter">Quarter</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="dailyAppointmentsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Appointment Status Chart -->
        <div class="col-md-4">
            <div class="card report-card bg-white mb-4">
                <div class="card-header bg-white">
                            <h5 class="mb-0">Appointment Status</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="appointmentStatusChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Doctor Utilization Chart -->
                <div class="col-md-6">
                    <div class="card report-card bg-white mb-4">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">Doctor Utilization</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="doctorUtilizationChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Specialization Distribution Chart -->
                <div class="col-md-6">
                    <div class="card report-card bg-white mb-4">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">Appointment by Specialization</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="specializationChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize charts
        initializeDailyAppointmentsChart();
        initializeAppointmentStatusChart();
        initializeDoctorUtilizationChart();
        
        // Set actual values from server
        document.getElementById('totalAppointments').textContent = '{{ total_appointments }}';
        document.getElementById('avgUtilization').textContent = '{{ avg_utilization }}';
        document.getElementById('newPatients').textContent = '{{ new_patients }}';
        document.getElementById('growthRate').textContent = '{{ "+" if growth_rate > 0 else "" }}{{ growth_rate }}%';
    });
    
    function initializeDailyAppointmentsChart() {
        const ctx = document.getElementById('dailyAppointmentsChart').getContext('2d');
        
        // We'll fetch actual data from the API in the next implementation
        fetch('/reporting/api/appointments/daily')
            .then(response => response.json())
            .then(data => {
                new Chart(ctx, {
                    type: 'bar',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Daily Appointment Volume'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error fetching daily appointments data:', error);
                // Demo data for now
                const demoData = {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Daily Appointments',
                        data: [12, 19, 15, 8, 22, 14, 10],
                        backgroundColor: 'rgba(122, 174, 159, 0.6)',
                        borderColor: 'rgba(122, 174, 159, 1)',
                    }]
                };
                
                new Chart(ctx, {
                    type: 'bar',
                    data: demoData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Daily Appointment Volume (Demo Data)'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            });
    }
    
    function initializeAppointmentStatusChart() {
        const ctx = document.getElementById('appointmentStatusChart').getContext('2d');
        
        // We'll fetch actual data from the API in the next implementation
        fetch('/reporting/api/appointments/status')
            .then(response => response.json())
            .then(data => {
                new Chart(ctx, {
                    type: 'doughnut',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                            },
                            title: {
                                display: true,
                                text: 'Appointments by Status'
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error fetching appointment status data:', error);
                // Demo data for now
                const demoData = {
                    labels: ['Completed', 'Cancelled', 'Pending', 'Confirmed'],
                    datasets: [{
                        data: [65, 15, 10, 25],
                        backgroundColor: [
                            'rgba(122, 174, 159, 0.6)',  // green
                            'rgba(248, 155, 147, 0.6)',  // coral
                            'rgba(74, 137, 220, 0.6)',   // blue
                            'rgba(255, 206, 84, 0.6)',   // yellow
                        ],
                    }]
                };
                
                new Chart(ctx, {
                    type: 'doughnut',
                    data: demoData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                            },
                            title: {
                                display: true,
                                text: 'Appointments by Status (Demo Data)'
                            }
                        }
                    }
                });
            });
    }
    
    function initializeDoctorUtilizationChart() {
        const ctx = document.getElementById('doctorUtilizationChart').getContext('2d');
        
        // We'll fetch actual data from the API in the next implementation
        fetch('/reporting/api/doctor/utilization')
            .then(response => response.json())
            .then(data => {
                new Chart(ctx, {
                    type: 'bar',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Appointments per Doctor'
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error fetching doctor utilization data:', error);
                // Demo data for now
                const demoData = {
                    labels: ['Dr. Smith', 'Dr. Johnson', 'Dr. Williams', 'Dr. Brown', 'Dr. Davis'],
                    datasets: [{
                        label: 'Appointments',
                        data: [25, 18, 22, 15, 20],
                        backgroundColor: 'rgba(122, 174, 159, 0.6)',
                        borderColor: 'rgba(122, 174, 159, 1)',
                    }]
                };
                
                new Chart(ctx, {
                    type: 'bar',
                    data: demoData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Appointments per Doctor (Demo Data)'
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            });
            
        // Initialize specialization chart with real data
        const ctxSpec = document.getElementById('specializationChart').getContext('2d');
        
        fetch('/reporting/api/appointments/by-specialization')
            .then(response => response.json())
            .then(data => {
                new Chart(ctxSpec, {
                    type: 'pie',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                            },
                            title: {
                                display: true,
                                text: 'Appointments by Specialization'
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error fetching specialization data:', error);
            });
    }
    
    // Export functionality
    document.getElementById('exportCSV').addEventListener('click', function() {
        // Redirect to CSV export route
        window.location.href = '{{ url_for("reporting.export_csv") }}';
    });
</script>
{% endblock %}